# ShadowChrome — руководство пользователя

ShadowChrome разворачивает полноценный клиент Shadowsocks прямо внутри браузера. Это руководство помогает тестировщикам, переводчикам и новым контрибьюторам пройти путь от установки до уверенной ежедневной работы, не заглядывая в исходники. Считайте документ практическим дополнением к архитектурному обзору в [`docs/DETAILED_DOCUMENTATION.ru.md`](DETAILED_DOCUMENTATION.ru.md).

## 1. Как устроено руководство

- **Когда оно пригодится.** У вас есть access key и вы хотите подключиться, вы только знакомитесь с расширениями Manifest V3 или вам нужна шпаргалка по сценариям ShadowChrome.
- **Необязательная подготовка.** Если терминология Shadowsocks кажется новой, сначала пролистайте раздел с понятиями. Каждый последующий блок опирается на них и предлагает конкретные действия.
- **Почитайте [Usage Policy](USAGE_POLICY.md).** В этом документе изложено, как авторы ожидают, что расширение будут использовать. Usage Policy доступна только на английском.

## 2. Основные понятия

Несколько повторяющихся терминов помогут увереннее ориентироваться в интерфейсе:

- **Access key** — строка, начинающаяся с `ss://` или `ssconf://`. Внутри зашифрованы адрес сервера, метод шифрования и иногда дополнительная метка. Провайдер может выдавать access key как подписку, которая разворачивается в набор серверов.
- **Outline Manager** — внешняя служба, умеющая выдавать и обновлять access keys Shadowsocks. ShadowChrome синхронизирует с ней список серверов.
- **CensorTracker** — каталог доменов с блоклистами и резервными серверами. Расширение использует его, чтобы поддерживать PAC-список и восстанавливаться после неудачных попыток подключения.
- **PAC script** — JavaScript-файл, который сообщает Chrome, какие домены отправлять через прокси, а какие открывать напрямую. ShadowChrome обслуживает его автоматически.

Если какое-то понятие осталось неочевидным, наведите курсор на блок **Узнать больше** на странице параметров — формулировки там совпадают с определениями выше.

## 3. Подготовка

### Что понадобится

- Google Chrome, Chromium или другой браузер на базе Chromium с поддержкой расширений Manifest V3.
- Node.js 18+ — только если вы планируете запускать линтер или менять код. Обычным пользователям этот пункт можно пропустить.
- Хотя бы один действующий access key (`ss://` или `ssconf://`) либо доступ к развернутому Outline Manager.

### Установка из репозитория

1. Клонируйте репозиторий.
2. Выполните `npm install`, чтобы подтянуть зависимости для разработки. Это не собирает расширение, а лишь готовит окружение.
3. Перейдите на страницу `chrome://extensions/`, включите **Режим разработчика** и нажмите **Загрузить распакованное**.
4. Укажите каталог `src/`. Chrome сразу зарегистрирует расширение и закрепит значок на панели инструментов.

Совет: не удаляйте репозиторий после установки. Чтобы обновить расширение, достаточно перезагрузить его на странице расширений.

## 4. Всплывающее окно: что в нем есть

Клик по значку открывает компактное всплывающее окно — это центр быстрого управления подключениями. Ниже перечислены элементы интерфейса:

1. **Переключатель языка** — синхронизируется со страницей параметров, чтобы оба интерфейса оставались на одном языке.
2. **Поле для access key** — вставьте строку `ss://` или `ssconf://` и нажмите **Импортировать ключ доступа**. ShadowChrome разберет ключ, сохранит все найденные серверы и свернет поле после успешного импорта.
3. **Список локаций** — появляется, когда в хранилище есть серверы. Строки сортируются по измеренной задержке; если данных нет, используется алфавитный порядок.
4. **Кнопки Connect / Disconnect** — запускают и останавливают встроенный клиент Shadowsocks. Подпись всегда отражает текущее состояние.
5. **Change access key** — повторно открывает форму ввода, если нужно вставить другой access key или подписку.
6. **Иконка настроек** — ведет на страницу параметров для тонкой настройки без выхода из всплывающего окна.
7. **Строка состояния** — показывает ход подключения, попытки перехода на резервный сервер и сообщения об ошибках. Атрибут `aria-live="polite"` помогает скринридерам.

Прежде чем подключаться, выделите минуту на знакомство с элементами. Это упростит дальнейшую диагностику.

## 5. Первое подключение

1. Вставьте действующий ключ в блок **Access key** и нажмите **Импортировать ключ доступа**. Для подписок ShadowChrome загрузит полный список серверов и сохранит их локально.
2. Выберите нужную локацию, если серверов несколько. Расширение запомнит последний выбор, чтобы вы могли быстро переподключаться.
3. Нажмите **Connect**. Сервис-воркер запускает локальный слушатель на `127.0.0.1:<порт>` (по умолчанию `1080`), активирует PAC-прокси и обновляет строку статуса до `Proxy running on 127.0.0.1:{port}`, когда все готово.
4. Работайте в интернете как обычно. Трафик, подпадающий под правила PAC, пойдет через зашифрованный туннель. Всплывающее окно можно закрыть — соединение останется активным, пока вы не отключитесь или браузер не выгрузит сервис-воркер.
5. Когда связь больше не нужна, нажмите **Disconnect**. Chrome вернет прежние настройки прокси, а статус изменится на `Proxy stopped`.

### Что означают статусы

- **Attempting CensorTracker fallback…** — основное подключение не удалось, ShadowChrome запрашивает резервные серверы у сети CensorTracker. Процесс автоматический.
- **Fallback connection active via {provider}.** — подключение восстановлено с помощью резервного сервера. Можно продолжать работать, но стоит позже обновить основной ключ.
- **CensorTracker fallback is unavailable.** — ни основной, ни резервный сервер не ответили. Проверьте access key, нажмите **Sync** или импортируйте новую подписку.
- **Proxy stopped / Proxy running** — штатные состояния простоя и активного подключения.

## 6. Управление серверами и ключами

- **Saved servers** — все импортированные серверы появляются в списке локаций и на странице параметров. Нажмите **Use**, чтобы подключиться сразу, или **Remove**, чтобы удалить устаревшую запись.
- **Смена подписок** — используйте кнопку **Change access key** во всплывающем окне или раздел на странице параметров. Новые ключи объединяются с существующими, а `serverStore.js` автоматически удаляет дубликаты.
- **Интеграция с Outline Manager** — добавьте API-адрес и, при необходимости, отпечаток сертификата на странице параметров. Сервис-воркер синхронизируется сразу и обновляет данные каждые 30 минут. Удаление менеджера очищает добавленные им серверы.

## 7. Страница параметров: что где лежит

Откройте страницу параметров через иконку шестеренки или по адресу `chrome-extension://<id>/options.html`. Она разделена на карточки с раскрывающимися блоками **Узнать больше**, в которых технические детали объясняются простым языком.

### Язык и локализация

- Выберите удобный язык интерфейса. Настройка сохраняется между сессиями и синхронизируется между устройствами, если в браузере включена синхронизация.

### Домены и PAC

- Переключатель **Use CensorTracker registry** включает доменный список из CensorTracker. Под ним отображаются источник, страна и время последнего обновления.
- Добавляйте собственные домены, чтобы направлять их через прокси, и удаляйте записи, когда они больше не нужны.
- Список **Ignored domains** позволяет обходить прокси для отдельных хостов (например, банковских порталов, которые блокируют VPN).
- Даже если списки пусты, ShadowChrome продолжит отправлять трафик `.onion` и `.i2p` через туннель; остальное пойдет напрямую.

### Saved servers

- Просматривайте все конфигурации, импортированные вручную или через Outline Manager. Кнопка **Use** подключает сразу, **Remove** удаляет сервер из обоих интерфейсов.

### Outline Managers

- Добавляйте или удаляйте endpoints Outline, смотрите время последней синхронизации, указывайте SHA-256 отпечаток сертификата для самоподписанных инстансов. Подсказка подсказывает, как получить fingerprint.

### Sync tools

- Кнопка **Sync** последовательно обновляет зеркала конфигураций, синхронизирует реестр CensorTracker и запускает обновление Outline Manager. Прогресс и ошибки отображаются в строке статуса под кнопкой.

### Diagnostics

- Кнопка **Diagnostics** собирает последний access key, состояние реестра, временные метки и буфер логов. JSON выводится прямо на странице, чтобы вы могли скопировать его при обращении к мейнтейнерам.
- В запросах на поддержку указывайте, какие шаги приводят к проблеме (например, «импортировал новую подписку, Sync завершился таймаутом»).

## 8. Что хранит расширение

ShadowChrome сохраняет состояние только в `chrome.storage.local` вашего профиля:

- `accessUrl` — последний использованный access key.
- `lastConfig` — очищенная конфигурация, переданная сервис-воркеру.
- `servers` — список серверов Shadowsocks из ручного импорта и Outline Manager.
- `domainRegistry` — домены, которые использует генератор PAC.
- `registryState` — настройки пользователя, список исключений, сведения о синхронизации и кэш резервных серверов CensorTracker.
- `censortrackerFallback` — последние резервные серверы, информация о провайдере и временные метки.
- `outlineManagers` — зарегистрированные менеджеры Outline.
- `logs` — буфер логов фонового процесса.

Удаление расширения из Chrome очищает все значения. Никакие данные не покидают профиль браузера.

## 9. Быстрый чек-лист по диагностике

1. **Ошибка появляется сразу после подключения.** Проверьте, что access key действителен и использует поддерживаемый шифр. Всплывающее окно показывает сообщение сервис-воркера.
2. **Не отображаются серверы Outline.** Нажмите **Sync**, чтобы обновить список, и убедитесь, что API Outline доступен.
3. **PAC работает странно.** Проверьте доменные списки. Правила применяются автоматически сразу после изменений.
4. **Diagnostics возвращает пустой результат.** Сервис-воркер мог выгрузиться. Откройте всплывающее окно, чтобы перезапустить его.
5. **Постоянно активируется fallback.** Вероятно, основной ключ устарел. Импортируйте свежую подписку или уточните статус серверов у провайдера.

## 10. Что изучить дальше

- Прочитайте архитектурный обзор в [`docs/DETAILED_DOCUMENTATION.ru.md`](DETAILED_DOCUMENTATION.ru.md), чтобы увидеть, как устроены подсистемы.
- Загляните в [`docs/architecture/`](architecture/), где собраны диаграммы последовательностей и подробный разбор компонентов.
- Перед тем как делиться ShadowChrome с коллегами или тестировщиками, обязательно прочитайте [Usage Policy](USAGE_POLICY.md).
<!-- Updated: 2025-10-01 -->
