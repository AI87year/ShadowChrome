# Module inventory

This catalog lists every significant file under `src/` and explains how it collaborates
with the rest of the extension. Paths are relative to the repository root.

## UI surfaces

| File | Responsibility |
| ---- | -------------- |
| [`src/popup.html`](../../src/popup.html) | Minimal markup for importing access keys, selecting a server, and toggling the connection. Every interactive element is wired up by `popup.js`. |
| [`src/popup.js`](../../src/popup.js) | Restores saved state from `ServerStore`, reacts to language changes, renders the server picker, and dispatches `start-proxy`/`stop-proxy` intents to the background worker. All long-running work is delegated to helper modules. |
| [`src/options.html`](../../src/options.html) | Full-screen management console that groups language settings, saved servers, CensorTracker controls, Outline integration, diagnostics, and contextual help. |
| [`src/options.js`](../../src/options.js) | Connects UI controls to the background worker, syncs `chrome.storage` with in-memory state, renders registries, and coordinates Outline managers. |

Both UI documents import [`src/i18n.js`](../../src/i18n.js) for translations and
[`src/browser-api.js`](../../src/browser-api.js) to normalize Promise-based access to the
Chrome APIs.

## Background and runtime core

| File | Responsibility |
| ---- | -------------- |
| [`src/background.js`](../../src/background.js) | Manifest V3 service worker that keeps the Shadowsocks client alive, manipulates Chrome's proxy settings, and responds to runtime messages from both UI surfaces. Hosts the `chrome.sockets` TCP implementation of the Shadowsocks protocol. |
| [`src/proxyManager.js`](../../src/proxyManager.js) | Wrapper for Chrome proxy APIs, responsible for generating PAC scripts (`pac.js`), applying them, and rolling back to a direct connection when the proxy stops. |
| [`src/pac.js`](../../src/pac.js) | Generates Proxy Auto-Config scripts that direct domain traffic according to the registry generated by `registry.js`. |
| [`src/serverStore.js`](../../src/serverStore.js) | Thin layer over `chrome.storage.local` that persists server configurations, active selection, and Outline metadata. Exposes change listeners for UI updates. |
| [`src/registry.js`](../../src/registry.js) | Maintains the domain routing registry used by the PAC generator. It merges built-in CensorTracker lists, custom overrides, and ignore rules. |
| [`src/diagnostics.js`](../../src/diagnostics.js) | Collects runtime data, recent logs, and storage snapshots into a structured report to simplify support interactions. |
| [`src/logger.js`](../../src/logger.js) | Lightweight logging facade that timestamps events and exposes pluggable sinks. Both UI and service-worker code reuse it for consistent output. |

## Networking and synchronization

| File | Responsibility |
| ---- | -------------- |
| [`src/serverClient.js`](../../src/serverClient.js) | Fetches access key mirrors, Outline Manager API responses, and CensorTracker datasets. Implements retry logic around the timeout helper. |
| [`src/censortrackerServer.js`](../../src/censortrackerServer.js) | Periodically refreshes CensorTracker domain lists and fallback server pools, storing results through `registry.js` and `serverStore.js`. |
| [`src/censortracker.js`](../../src/censortracker.js) | Reads the embedded domain JSON and exposes a Promise-based API to the rest of the extension. |
| [`src/outlineManager.js`](../../src/outlineManager.js) | Tracks Outline Manager instances configured by the user, performs credentialed fetches to each server, and merges new Shadowsocks configs into the main store. |
| [`src/utils/fetchWithTimeout.js`](../../src/utils/fetchWithTimeout.js) | Abortable fetch helper that enforces MV3-safe timeouts and returns typed error objects for diagnostics. |
| [`src/utils/withTimeout.js`](../../src/utils/withTimeout.js) | Generic Promise timeout wrapper used by long-running jobs that do not rely on the Fetch API. |

## Access-key parsing and protocol helpers

| File | Responsibility |
| ---- | -------------- |
| [`src/ssConfig.js`](../../src/ssConfig.js) | Parses `ss://`, `ssconf://`, and Outline JSON payloads into normalized configuration objects. Handles nested subscriptions, url-safe Base64, IPv6 literals, and Outline-provided tags. |
| [`src/integrations/shadowsocksCiphers.js`](../../src/integrations/shadowsocksCiphers.js) | Canonical list of supported Shadowsocks AEAD ciphers with metadata used for validation and UI hints. |
| [`src/integrations/outlineAccessKey.js`](../../src/integrations/outlineAccessKey.js) | Port of the Outline SDK access-key parser that serves as the foundation for `ssConfig.js`. |
| [`src/browser-api.js`](../../src/browser-api.js) | Compatibility wrapper that provides Promise versions of Chrome extension APIs and gracefully degrades in Firefox-based environments. |

## Data and storage

ShadowChrome stores a handful of well-known keys inside `chrome.storage.local`. These are
managed exclusively through `serverStore.js`, `registry.js`, and `censortrackerServer.js`.
Developers should avoid writing to them directly to prevent subtle races.

| Key | Shape | Owner |
| --- | ----- | ----- |
| `servers` | Array of normalized config objects from `ssConfig.js`. Each entry contains `id`, `method`, `password`, `host`, `port`, optional `plugin`, `pluginOptions`, and Outline tags. | `serverStore.js` |
| `activeServerId` | String identifier of the currently selected configuration. | `serverStore.js` |
| `outlineManagers` | Array of manager descriptors `{id, apiUrl, certSha256, name}` used by `outlineManager.js` for syncing. | `outlineManager.js` |
| `censortrackerRegistry` | Object containing domain lists, ignore sets, and timestamps used to build the PAC registry. | `registry.js` / `censortrackerServer.js` |
| `fallbackServers` | Cached Shadowsocks endpoints returned by the CensorTracker network, each normalized through `ssConfig.js`. | `censortrackerServer.js` |
| `settings` | Miscellaneous feature flags including `language`, `useCensortracker`, and override toggles exposed in the UI. | `options.js` |

## Message channels

Runtime coordination happens through `chrome.runtime.sendMessage` with a small set of
message types. Their handlers live in `background.js`.

| Message | Sender | Purpose |
| ------- | ------ | ------- |
| `start-proxy` | Popup / Options | Activate the Shadowsocks client for the given server ID or payload. |
| `stop-proxy` | Popup / Options | Tear down the client and restore direct proxy settings. |
| `sync` | Options | Trigger a mirror refresh that fetches Outline managers, access-key mirrors, and CensorTracker data in sequence. |
| `sync-outline` | Options | Force Outline Manager synchronization without touching other datasets. |
| `sync-censortracker` | Options | Refresh CensorTracker domains and fallback servers. |
| `get-censortracker-fallback` | Popup | Request cached fallback servers when a direct connection fails. |
| `diagnostics` | Options | Build and return a diagnostics package for export. |

Adhering to this inventory ensures new features integrate cleanly without duplicating or
bypassing existing abstractions.
<!-- Updated: 2025-10-01 -->
